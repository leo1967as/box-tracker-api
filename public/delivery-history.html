<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>üì¶ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á</title>
  <link rel="stylesheet" href="style.css" />
  <!-- ‡πÉ‡∏™‡πà‡πÑ‡∏ß‡πâ‡πÉ‡∏ô <head> -->
<link rel="stylesheet" href="css/navbar.css" />

  <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://*.googleapis.com https://*.gstatic.com; style-src 'self' 'unsafe-inline';"> -->

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore-compat.js"></script>
</head>
<body>

  <!-- Navbar ‡πÄ‡∏î‡∏¥‡∏° -->
  <nav class="navbar">
    <div class="logo">MyWebApp üöÄ</div>
    <ul class="nav-links">
      <li><a href="index.html">‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</a></li>
      <li><a href="routes.html">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</a></li>
      <li><a href="delivery-history.html">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á</a></li>
      <li><a href="organizations.html">‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô</a></li>
      <li><a href="delivery.html">‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏™‡πà‡∏á</a></li>
    </ul>
  </nav>

  <!-- ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏´‡∏•‡∏±‡∏Å -->
  <div class="content-wrapper">
    <h1>üì¶ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h1>
    
    <div class="filter-controls">
      <select id="statusFilter">
        <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <option value="‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á</option>
        <option value="‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡πâ‡∏ß">‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</option>
      </select>
      
      <input type="date" id="dateFilter">
      
      <select id="routeFilter">
        <option value="all">‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
        <!-- ‡∏à‡∏∞‡πÄ‡∏ï‡∏¥‡∏°‡∏î‡πâ‡∏ß‡∏¢ JavaScript -->
      </select>
      
      <button id="applyFilter">üîç ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
      <button id="resetFilter">üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</button>
    </div>
    
    <div id="deliveriesContainer">‚åõ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
  </div>

  <script>
    // ‡∏Ñ‡∏≠‡∏ô‡∏ü‡∏¥‡∏Å Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDj4aYtdPAI3-uWGKUUcScYaTn66vhuTHt4",
      authDomain: "tissueboxdb.firebaseapp.com",
      projectId: "tissueboxdb",
      storageBucket: "tissueboxdb.appspot.com",
      messagingSenderId: "578294379663",
      appId: "1:578294379663:web:592d86722575dcc1676cfa",
      measurementId: "G-CE000PRNNC"
    };

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    let allRoutes = [];
    let allDeliveries = [];

    // ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å Firestore
    async function loadRoutes() {
      try {
        const snapshot = await db.collection("routes").get();
        allRoutes = snapshot.docs.map(doc => {
          const data = doc.data();
          return {
            id: doc.id,
            ...data,
            routeText: `${data.start} ‚Üí ${data.end}`
          };
        });
        
        // ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô dropdown ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
        const routeFilter = document.getElementById("routeFilter");
        allRoutes.forEach(route => {
          const option = document.createElement("option");
          option.value = route.routeText;
          option.textContent = route.routeText;
          routeFilter.appendChild(option);
        });
      } catch (error) {
        console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á:", error);
      }
    }

    // ‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á
    async function loadDeliveries(filter = {}) {
      const container = document.getElementById("deliveriesContainer");
      container.innerHTML = "‚åõ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...";
      
      try {
        let query = db.collection("deliveries").orderBy("createdAt", "desc");
        
        // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        if (filter.status && filter.status !== "all") {
          query = query.where("status", "==", filter.status);
        }
        
        // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà
        if (filter.date) {
          const startDate = new Date(filter.date);
          startDate.setHours(0, 0, 0, 0);
          
          const endDate = new Date(filter.date);
          endDate.setHours(23, 59, 59, 999);
          
          query = query.where("createdAt", ">=", startDate)
                      .where("createdAt", "<=", endDate);
        }
        
        // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
        if (filter.route && filter.route !== "all") {
          const [start, end] = filter.route.split(" ‚Üí ");
          query = query.where("start", "==", start)
                      .where("end", "==", end);
        }
        
        const snapshot = await query.limit(100).get();
        
        if (snapshot.empty) {
          container.innerHTML = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç";
          return;
        }
        
        allDeliveries = snapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        
        renderDeliveries(allDeliveries);
      } catch (error) {
        console.error("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á:", error);
        container.innerHTML = `‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${error.message}`;
      }
    }
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á
    function renderDeliveries(deliveries) {
      const container = document.getElementById("deliveriesContainer");
      
      if (deliveries.length === 0) {
        container.innerHTML = "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á";
        return;
      }
      
      container.innerHTML = "";
      
      deliveries.forEach(delivery => {
        const startTime = delivery.startTime?.toDate?.();
        const stopTime = delivery.stopTime?.toDate?.();
        
        // ‡∏´‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏à‡∏≤‡∏Å allRoutes
        const route = allRoutes.find(r => 
          r.start === delivery.start && r.end === delivery.end
        );
        const standardDuration = route?.duration || delivery.standardDuration;
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
        const card = document.createElement("div");
        card.className = "delivery-card";
        
        // ‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏Å‡∏≤‡∏£‡πå‡∏î
        const title = document.createElement("h4");
        title.textContent = `${delivery.itemName} ‚Üí ${delivery.receiverName}`;
        card.appendChild(title);
        
        // ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
        const routeInfo = document.createElement("p");
        routeInfo.innerHTML = `<strong>‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á:</strong> ${delivery.start} ‚Üí ${delivery.end}`;
        card.appendChild(routeInfo);
        
        // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏á
        const startTimeDiv = document.createElement("div");
        startTimeDiv.innerHTML = `<strong>‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡πà‡∏á:</strong> ${startTime ? startTime.toLocaleString() : 'N/A'}`;
        card.appendChild(startTimeDiv);
        
        // ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        const statusDiv = document.createElement("div");
        statusDiv.innerHTML = `<strong>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</strong> <span class="status-${delivery.status === '‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡πâ‡∏ß' ? 'delivered' : 'sending'}">${delivery.status}</span>`;
        card.appendChild(statusDiv);
        
        // ‡∏ñ‡πâ‡∏≤‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
        if (delivery.status === "‡∏ñ‡∏∂‡∏á‡πÅ‡∏•‡πâ‡∏ß") {
          // ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏∂‡∏á
          const stopTimeDiv = document.createElement("div");
          stopTimeDiv.innerHTML = `<strong>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏∂‡∏á:</strong> ${stopTime ? stopTime.toLocaleString() : 'N/A'}`;
          card.appendChild(stopTimeDiv);
          
          // ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ
          const durationDiv = document.createElement("div");
          durationDiv.innerHTML = `<strong>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ:</strong> ${delivery.actualDuration} ‡∏ô‡∏≤‡∏ó‡∏µ (‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô: ${standardDuration || 'N/A'} ‡∏ô‡∏≤‡∏ó‡∏µ)`;
          card.appendChild(durationDiv);

        }

        container.appendChild(card);
      });
    }

    // ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
    document.getElementById("applyFilter").addEventListener("click", () => {
      const status = document.getElementById("statusFilter").value;
      const date = document.getElementById("dateFilter").value;
      const route = document.getElementById("routeFilter").value;

      loadDeliveries({ status, date, route });
    });

    // ‡∏õ‡∏∏‡πà‡∏°‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
    document.getElementById("resetFilter").addEventListener("click", () => {
      document.getElementById("statusFilter").value = "all";
      document.getElementById("dateFilter").value = "";
      document.getElementById("routeFilter").value = "all";
      loadDeliveries(); // ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    });

    // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
    loadRoutes().then(() => {
      loadDeliveries();
    });
  </script>

  <!-- ‡πÅ‡∏ñ‡∏° CSS ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏Ç‡∏∂‡πâ‡∏ô -->
  <style>
    .content-wrapper {
      padding: 2rem;
      max-width: 900px;
      margin: 0 auto;
    }
    .filter-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      margin-bottom: 1.5rem;
    }
    .filter-controls select,
    .filter-controls input[type="date"],
    .filter-controls button {
      padding: 0.4rem 0.8rem;
      font-size: 1rem;
    }
    .delivery-card {
      border: 1px solid #ddd;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      background-color: #fffefc;
    }
    .delivery-card h4 {
      margin-top: 0;
      color: #333;
    }
    .status-delivered {
      color: green;
      font-weight: bold;
    }
    .status-sending {
      color: orange;
      font-weight: bold;
    }
  </style>
</body>
</html>
